#!/bin/bash
set -e

SERVICE_NAME=${SERVICE_NAME:-nginx}
CONSUL=${CONSUL:-consul}
CERT_DIR="/var/www/ssl"


# Generate a conf.d config file for every corresponding conf.d Consul template
for f in $(ls -1 /etc/nginx/templates/conf.d/)
do
    consul-template \
        -once \
        -dedup \
        -consul-addr "${CONSUL}:8500" \
        -template "/etc/nginx/templates/conf.d/${f}:/etc/nginx/conf.d/${f}"
done

# Render Nginx configuration template using values from Consul
consul-template \
    -once \
    -dedup \
    -consul-addr "${CONSUL}:8500" \
    -template "/etc/nginx/templates/health.conf:/etc/nginx/health.conf" \
    -template "/etc/nginx/templates/nginx.conf:/etc/nginx/nginx.conf"
